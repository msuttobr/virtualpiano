<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
            content="Toque suas músicas favoritas com o Piano Virtual. Uma experiência de piano online completa.">
        <title>Piano Virtual</title>
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <div class="container">
            <div class="description">
                Utilize <kbd>Tab</kbd> para primeira oitava<br>
                Utilize <kbd>CapsLock</kbd> para última oitava<br>
                Utilize <kbd>ShiftLeft</kbd> para recuar a oitava<br>
                Utilize <kbd>ControlLeft</kbd> para avançar a oitava
            </div>
            <div class="piano"></div>
        </div>
        <script type="module">

import { notesSound } from './soundfonts/acoustic_grand_piano_trimmed-ogg.js'

const keys = [
    "Z", "S", "X", "D", "C", "V", "G", "B", "H", "N", "J", "M", ",", "L", ".", "Ç", ";",
    "Q", "2", "W", "3", "E", "4", "R", "T", "6", "Y", "7", "U", "I", "9", "O", "0", "P", "-", 'DEAD'
];

const notes = Object.keys(notesSound)

const keysOffset = {
    "Tab": -100,
    "CapsLock": 100,
    "ShiftLeft": -12,
    "ControlLeft": 12
}

let selected = 0;
const final = notes.length;

const pianoElement = document.querySelector('.piano');
let isMouseDown = false;

function updateLabels(index) {
    const labels = document.querySelectorAll('.key-label');

    const keysButton = document.querySelectorAll('.key');
    document.querySelectorAll('.selected').forEach(item => {
        item.classList.remove('selected')
    });

    for (let i = 0; i < notes.length; i++) {
        labels[i].innerText = notes[i];
    }
    
    for (let i = 0; i < keys.length; i++) {
        labels[index + i].innerText = keys[i] !== "DEAD" ? keys[i] : "´";
        keysButton[index + i].classList.add('selected');
    }
}
function playNote(note) {
    const audio = new Audio(note);
    audio.play();
}
function activateKey(note, key) {
    playNote(notesSound[note]);
    key.classList.add('active');
}
function deactivateKey(key) {
    key.classList.remove('active');
}

notes.forEach(note => {
    const key = document.createElement('div');
    key.classList.add('key');
    key.dataset.note = note;
    key.classList.add(note.length === 3 ? 'black': 'white')

    const label = document.createElement('div');
    label.classList.add('key-label');
    label.innerText = note;
    key.appendChild(label);

    if (note.includes('#')) {
        key.classList.add('black');
    }

    key.addEventListener('mousedown', _ => {
        isMouseDown = true;
        activateKey(note, key);
    });

    key.addEventListener('mouseup', event => {
        isMouseDown = false;
        deactivateKey(event.target)
    });

    key.addEventListener('mousemove', event => {
        if (isMouseDown && event.target === key) {
            if (!key.classList.contains('active')) {
                activateKey(note, key);
            }
        }
    });

    key.addEventListener('mouseleave', event => {
        deactivateKey(event.target);
    });

    pianoElement.appendChild(key);
});

window.addEventListener('keydown', event => {
    let keyPressed = event.key.toUpperCase();
    let index = keys.indexOf(keyPressed);

    if (index !== -1) {
        const note = notes[selected + index];
        const key = pianoElement.querySelector(`[data-note="${note}"]`);
        if (key && !key.classList.contains('active')) {
            activateKey(note, key);
        }
    }
    keyPressed = event.code;
    if (keysOffset[keyPressed] !== undefined) {
        selected += keysOffset[keyPressed];
        if (selected < 0) selected = 0;
        else if (selected > final - keys.length) {
            selected = final - keys.length;
        }

        updateLabels(selected);
    }
})
window.addEventListener('keyup', event => {
    const keyPressed = event.key.toUpperCase();
    const index = keys.indexOf(keyPressed);

    if (index !== -1) {
        const note = notes[selected + index];
        const key = pianoElement.querySelector(`[data-note="${note}"]`);
        if (key && key.classList.contains('active')) {
            deactivateKey(key);
        }
    }
});

updateLabels(selected);
        </script>
    </body>
</html>