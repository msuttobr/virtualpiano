<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
            content="Toque suas músicas favoritas com o Piano Virtual. Uma experiência de piano online completa.">
        <title>Piano Virtual</title>
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <section class="instruments">
            <div class="container">
                <div class="instruments-info">
                    <div class="description">
                        Utilize <kbd>Tab</kbd> para primeira oitava<br>
                        Utilize <kbd>CapsLock</kbd> para última oitava<br>
                        Utilize <kbd>ShiftLeft</kbd> para recuar a oitava<br>
                        Utilize <kbd>ControlLeft</kbd> para avançar a oitava
                    </div>
                </div>
                <div class="macro">
                    <div><label><input type="checkbox" name="enable-macro">Enable Macro Record</label></div>
                    <div><label><input type="checkbox" name="run-macro">Run Macro</label></div>
                    <div><label><input type="checkbox" name="repeat-macro">Repeat Macro</label></div>
                    <div><textarea name="macro-list"></textarea></div>
                    <div class="error-piano-macro"></div>
                </div>
                <div class="piano"></div>
            </div>
        </section>
        <script type="module">
import { notesSound } from './soundfonts/acoustic_grand_piano_trimmed-ogg.js'
import { NoteParser } from './js/noteparser.js'

const macroElement = document.getElementsByName('enable-macro')[0]
const runMacroElement = document.getElementsByName('run-macro')[0]
const repeatMacroElement = document.getElementsByName('repeat-macro')[0]
const macroListElement = document.getElementsByName('macro-list')[0]
const pianoElement = document.querySelector('.piano');

let macro = undefined
let textMacro = ""
let selected = 0;
let isMouseDown, isMacroRunning = false;
const notes = Object.keys(notesSound)
const allKeys = {}

const keys = [
    "Z", "S", "X", "D", "C", "V", "G", "B", "H", "N", "J", "M", ",", "L", ".", "Ç", ";",
    "Q", "2", "W", "3", "E", "4", "R", "T", "6", "Y", "7", "U", "I", "9", "O", "0", "P", "-", 'DEAD'
];
const end = notes.length
const final = end - keys.length
const keysOffset = {
    "Tab": -100,
    "CapsLock": 100,
    "ShiftLeft": -12,
    "ControlLeft": 12
}

main()

function playNote(note) {
    const audio = new Audio(note);
    audio.play();
}
function activateKey(note, key) {
    playNote(notesSound[note]);
    key.classList.add('active');
    if (macroElement.checked) {
        macro(note)
    }
}
function deactivateKey(key) {
    key.classList.remove('active');
}
function enableMacro() {
    let oldTime = 0;
    let text = ""
    return function(note){
        const date = Date.now();
        let delay = oldTime === 0 ? 0 : date - oldTime;

        text += `${note},${delay} `;
        macroListElement.value = text
        oldTime = date;
    }
}
async function runMacro() {
    console.log('running macro')
    isMacroRunning = true
    for (let noteDelay of textMacro) {
        const [note, delay] = noteDelay.split(',')

        await activateKeyMacro(note, Number(delay))
    }
    isMacroRunning = false
}
async function activateKeyMacro(note, delay) {
    allKeys[note].classList.add('active-macro')
    await sleep(delay)
    let e = new Event('mousedown')
    allKeys[note].dispatchEvent(e)
    e = new Event('mouseup')
    allKeys[note].dispatchEvent(e)
    allKeys[note].classList.remove('active-macro')
}

window.addEventListener('change', async event => {
    const target = event.target
    if (target === macroElement) {
        if (macroElement.checked) {
            macro = enableMacro()
        }
    } else if (target === runMacroElement || target === repeatMacroElement) {
        const error = document.querySelector('.error-piano-macro')
        error.innerText = ""
        if (!target.checked) {
            console.log('obrigado por ter tocado uma música')
            return;
        }
        macroElement.checked = false
        const noteParser = new NoteParser();
        let text = macroListElement.value.replace(/\s+/g, ' ').trim().split(' ')
        for (let notems of text) {
            noteParser.parse(notems)
        }

        if (!!noteParser.error.length) {
            error.innerText = noteParser.error
            runMacroElement.checked = false
            macroElement.checked = false
            return
        } else {
            textMacro = text
            macroListElement.value = macroListElement.value.replace(/\s+/g, ' ').trim()
        }

        if (runMacroElement.checked) {
            await runMacro()
        } else {
            while (repeatMacroElement.checked) {
                await runMacro();
                await sleep(500)
            }
        }
        target.checked = false;
    }
})

window.addEventListener('keydown', event => {
    let keyPressed = event.key.toUpperCase();
    let index = keys.indexOf(keyPressed);

    if (index !== -1) {
        const note = notes[selected + index];
        const key = pianoElement.querySelector(`[data-note="${note}"]`);
        if (key && !key.classList.contains('active')) {
            activateKey(note, key);
        }
    }
    keyPressed = event.code;
    let oldSelected = 0;
    if (keysOffset[keyPressed] !== undefined) {
        oldSelected = selected;
        selected += keysOffset[keyPressed];
        if (selected < 0) selected = 0;
        else if (selected > final) {
            selected = final;
        }

        updateLabels(oldSelected, selected);
    }
})
window.addEventListener('keyup', event => {
    const keyPressed = event.key.toUpperCase();
    const index = keys.indexOf(keyPressed);

    if (index !== -1) {
        const note = notes[selected + index];
        const key = pianoElement.querySelector(`[data-note="${note}"]`);
        if (key && key.classList.contains('active')) {
            deactivateKey(key);
        }
    }
});
window.addEventListener('mouseup', event => {
    isMouseDown = false;
});

function sleep(delay) {
    return new Promise(resolve => setTimeout(resolve, delay))
}
function removeSelected() {
    document.querySelectorAll('.selected').forEach(item => {
        item.classList.remove('selected')
    });
}
function paintLabels() {
    const keysButton = document.querySelectorAll('.key');
    for (let i = 0; i < end; i++) {
        keysButton[i].innerText = notes[i];
    }
}
function updateLabels(oldSelected, index) {
    removeSelected();
    if (index === undefined) index = 0
    const keysButton = document.querySelectorAll('.key');

    for (let i = oldSelected; i < index; i++) {
        keysButton[i].innerText = notes[i];
    }
    for (let i = index; i < end; i++) {
        keysButton[i].innerText = notes[i];
    }
    
    for (let i = 0; i < keys.length; i++) {
        keysButton[index + i].innerText = keys[i] !== "DEAD" ? keys[i] : "´";
        keysButton[index + i].classList.add('selected');
    }
}
function main() {
    notes.forEach(note => {
        const key = document.createElement('div');
        key.classList.add('key');
        key.dataset.note = note;
        key.classList.add(note.length === 3 ? 'black': 'white')

        if (note.includes('#')) {
            key.classList.add('black');
        }
        key.addEventListener('mouseup', event => {
            isMouseDown = false;
            deactivateKey(event.target)
        });
        key.addEventListener('mousedown', _ => {
            isMouseDown = true;
            activateKey(note, key);
        });
        key.addEventListener('mousemove', event => {
            if (!isMacroRunning && isMouseDown && event.target === key) {
                if (!key.classList.contains('active')) {
                    activateKey(note, key);
                }
            }
        });
        key.addEventListener('mouseleave', event => {
            deactivateKey(event.target);
        });

        pianoElement.appendChild(key);
        allKeys[note] = key 
    });
    
    paintLabels();
    updateLabels(selected)
}
        </script>
    </body>
</html>